name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        continue-on-error: true
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ steps.app-token.outputs.token }}

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            IMPORTANT - Edit Previous Reviews to be Shorter:
            Before writing your new review, use `gh pr view ${{ github.event.pull_request.number }} --json comments` to fetch existing comments.
            If there are previous Claude Code Review comments that are verbose (comments from github-actions bot or containing "Claude Code Review"):
            1. Identify the comment ID and body for each verbose Claude review comment
            2. For each verbose comment, create a condensed version that keeps only:
               - Critical issues and bugs
               - Actionable suggestions
               - Final verdict/summary
               - Remove: excessive explanations, minor observations, redundant context
            3. Use `gh api --method PATCH /repos/${{ github.repository }}/issues/comments/{comment_id} -f body='<condensed_text>'` to update each comment
            4. Ensure the condensed version is significantly shorter (aim for 50% or less of original length)

            This helps reduce comment volume in PR threads while preserving key information.

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            CRITICAL - Verify Software Versions Before Claiming They Don't Exist:
            Before claiming that a software version doesn't exist or hasn't been released, you MUST:
            1. Search the web for the latest version of the software in question
            2. Check official sources (GitHub releases, package registries, official documentation)
            3. Cite your sources when making version-related claims
            If you cannot verify a version exists, say "I was unable to verify this version" rather than asserting it doesn't exist.

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

